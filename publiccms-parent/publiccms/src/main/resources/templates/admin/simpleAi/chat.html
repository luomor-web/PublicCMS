<div class="pageFormContent" layoutH>
    <#assign index=0/>
    <form>
        <dl class="nowrap">
            <dt><@t.page 'content'/>:</dt>
            <dd>
                <#if scene?has_content && "html"=scene>
                    <input name="messages[0].role" value="system" type="hidden"/>
                    <input name="messages[0].content" value="ONLY USE HTML, CSS AND JAVASCRIPT. If you want to use ICON make sure to import the library first. Try to create the best UI possible by using only HTML, CSS and JAVASCRIPT. Use as much as you can TailwindCSS for the CSS, if you can't do something with TailwindCSS, then use custom CSS (make sure to import &lt;script src=\"https://cdn.tailwindcss.com\"&gt;&lt;/script&gt; in the head). Also, try to ellaborate as much as you can, to create something unique. ALWAYS GIVE THE RESPONSE INTO A SINGLE HTML FILE" type="hidden"/>
                    <input name="messages[1].role" value="assistant" type="hidden"/>
                    <input name="messages[1].content" class="html" value="The current code is: " type="hidden"/>
                    <#assign index=2/>
                </#if>
                <input name="messages[${index}].role" value="user" type="hidden"/>
                <textarea name="messages[${index}].content" class="input" rows="3" cols="50"></textarea>
                <button type="button" class="buttonActive"><@t.page 'button.send'/></button>
                <#assign index++/>
            </dd>
        </dl>
        <dl class="nowrap">
            <dt><@t.page 'reply'/>:</dt>
            <dd>
                <textarea class="result" rows="10" cols="80"></textarea>
            </dd>
        </dl>
    </form>
</div>
<div class="formBar">
    <ul>
        <li><button type="button" class="button mdImport buttonDisabled"><@t.page 'use'/></button></li>
        <li><button type="button" class="button close"><@t.page 'button.close'/></button></li>
    </ul>
</div>
<script>
$(".input",$.pdialog.getCurrent()).on("change", function(){
    $(".buttonActive",$.pdialog.getCurrent()).prop("disabled",true).addClass("buttonDisabled");
    if($(this).val()){
        $(".buttonActive",$.pdialog.getCurrent()).prop("disabled",false).removeClass("buttonDisabled");
    }
});
$('form',navTab.getCurrentPanel()).trigger(JUI.eventType.editorSync);
<#if scene?has_content && "html"=scene>
$(".html",$.pdialog.getCurrent()).val($(".html",$.pdialog.getCurrent()).val()+$("[name=${field!'text'}]",navTab.getCurrentPanel()).val()+".");
<#else>
$(".input",$.pdialog.getCurrent()).val($("[name=${field!'text'}]",navTab.getCurrentPanel()).val());
</#if>
$(".mdImport",$.pdialog.getCurrent()).on("click", function(){
    $.bringBack({"${field!'text'}":$("textarea.result",$.pdialog.getCurrent()).val()});
});
$(".buttonActive",$.pdialog.getCurrent()).on("click",function(){
    $(".mdImport",$.pdialog.getCurrent()).prop("disabled",true).addClass("buttonDisabled");
    $(".buttonActive",$.pdialog.getCurrent()).prop("disabled",true).addClass("buttonDisabled");
    fetch("simpleAi/chat?_csrf=<@tools.csrfToken admin=true/>",{
            "method":"POST",
            "headers":{
                "content-type":"application/x-www-form-urlencoded"
            },
            "body":$( "form",$.pdialog.getCurrent()).serialize()
        }).then(response => {
            if (!response.ok) {
                throw new Error('网络响应异常');
            }
            return response.body;
        }).then(body => {
            var reader = body.getReader();
            var decoder = new TextDecoder('utf-8');
            var result = "";
            function read() {
                return reader.read().then(({done, value}) => {
                    if (done) {
                        $(".mdImport",$.pdialog.getCurrent()).prop("disabled",false).removeClass("buttonDisabled");
                        $(".buttonActive",$.pdialog.getCurrent()).prop("disabled",false).removeClass("buttonDisabled");
                        return;
                    }
                    var json = decoder.decode(value);
                    if(json){
                        var lines = json.split("\n");
                        for (var line of lines) {
                            if(line){
                                var jsonObj = JSON.parse(line);
                                if(jsonObj && jsonObj.choices && 0 < jsonObj.choices.length && jsonObj.choices[0] && jsonObj.choices[0].delta && jsonObj.choices[0].delta.content){
                                    result += jsonObj.choices[0].delta.content;
                                }
                            }
                        }
                        $("textarea.result",$.pdialog.getCurrent()).val(result);
                        $("textarea.result",$.pdialog.getCurrent()).scrollTop($("textarea.result",$.pdialog.getCurrent())[0].scrollHeight);
                    }
                    return read();
                });
            }
            return read();
        }).catch(error => alertMsg.error(error));
});
</script>